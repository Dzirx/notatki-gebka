<!DOCTYPE html>
<html>
<head>
    <title>Notatnik Warsztatowy</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        input, textarea, select { 
            padding: 12px; margin: 5px; border: 1px solid #ddd; 
            border-radius: 6px; font-size: 14px;
        }
        textarea { width: calc(100% - 24px); height: 120px; resize: vertical; box-sizing: border-box; }
        button { 
            padding: 12px 24px; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 14px; transition: all 0.3s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        
        .header { 
            background: white; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { margin: 0; }
        
        table { 
            width: 100%; border-collapse: collapse; margin: 20px 0; 
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f9fa; font-weight: 600; }
        .notatka-pojazd { background: #d1ecf1; cursor: pointer; }
        .notatka-pojazd:hover { background: #b8daff; }
        .notatka-szybka { background: #fff3cd; }
        
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
        }
        .modal-content { 
            background: white; margin: 5% auto; padding: 30px; 
            width: 90%; max-width: 500px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .close { 
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            cursor: pointer; line-height: 1;
        }
        .close:hover { color: #000; }
        
        .search-rej {
            display: flex; align-items: center; margin-bottom: 15px;
        }
        .search-rej input { flex: 1; margin-right: 10px; }
        
        .hidden { display: none !important; }
        
        .actions-bar {
            background: white; padding: 15px; border-radius: 8px; 
            margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üöó Notatnik Warsztatowy</h1>
            <button class="btn-success" onclick="openModal()">+ Dodaj Notatkƒô</button>
        </div>

        <!-- WYSZUKIWANIE -->
        <div class="search-rej">
            <input type="text" id="searchRejInput" placeholder="Wyszukaj po numerze rejestracyjnym..." oninput="filterNotatkiByRej()">
            <button class="btn-secondary" onclick="clearRejSearch()">Wyczy≈õƒá</button>
        </div>

        <!-- AKCJE GRUPOWE -->
        <div class="actions-bar">
            <button class="btn-warning" onclick="editSelected()">‚úèÔ∏è Edytuj zaznaczone</button>
            <button class="btn-danger" onclick="deleteSelected()">üóëÔ∏è Usu≈Ñ zaznaczone</button>
            <span style="margin-left: 15px; color: #6c757d;">Zaznacz notatki checkboxami w tabeli</span>
        </div>

        <!-- TABELA NOTATEK -->
        <h3>üìù Wszystkie notatki</h3>
        <table>
            <thead>
                <tr>
                    <th width="40">
                        <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                    </th>
                    <th>Data</th>
                    <th>W≈Ça≈õciciel</th>
                    <th>Pojazd</th>
                    <th>Tre≈õƒá</th>
                </tr>
            </thead>
            <tbody>
                {% for notatka in notatki %}
                <tr class="notatka-{{ notatka.typ_notatki }}" data-nr-rej="{% if notatka.samochod %}{{ notatka.samochod.nr_rejestracyjny }}{% endif %}">
                    <td>
                        <input type="checkbox" class="note-checkbox" value="{{ notatka.id }}">
                    </td>
                    <td>{{ notatka.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>
                        {% if notatka.samochod and notatka.samochod.klient %}
                            {{ notatka.samochod.klient.imie }} {{ notatka.samochod.klient.nazwisko }}
                        {% else %}
                            Szybka notatka
                        {% endif %}
                    </td>
                    <td>
                        {% if notatka.samochod %}
                            {{ notatka.samochod.nr_rejestracyjny }}
                            <br><small>{{ notatka.samochod.marka }} {{ notatka.samochod.model }}</small>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ notatka.tresc }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- MODAL: DODAJ NOTATKƒò -->
        <div id="noteModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h3>Dodaj Notatkƒô</h3>
                <form action="/notatka/add" method="post">
                    <div class="form-group">
                        <select id="typ_notatki" name="typ_notatki" onchange="toggleNotatkType()" required>
                            <option value="">Wybierz typ notatki</option>
                            <option value="szybka">‚ö° Szybka notatka</option>
                            <option value="pojazd">üöô Notatka do pojazdu</option>
                        </select>
                    </div>
                    
                    <div id="nr_rej_group" class="form-group hidden">
                        <input type="text" id="nr_rejestracyjny" name="nr_rejestracyjny" placeholder="Numer rejestracyjny pojazdu">
                        <button type="button" class="btn-primary" onclick="pobierzInformacje()">üìã Pobierz informacje</button>
                    </div>
                    
                    <div id="pojazd_info" class="hidden" style="background: #e7f3ff; padding: 15px; margin: 10px 0; border-radius: 6px;">
                        <!-- Informacje o poje≈∫dzie -->
                    </div>
                    
                    <div class="form-group">
                        <textarea name="tresc" placeholder="Tre≈õƒá notatki..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn-primary">Zapisz</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Anuluj</button>
                </form>
            </div>
        </div>

        <!-- MODAL: EDYTUJ NOTATKƒò -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <h3>Edytuj Notatkƒô</h3>
                <form id="editForm">
                    <div class="form-group">
                        <textarea id="edit_tresc" placeholder="Tre≈õƒá notatki..." required></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Zapisz zmiany</button>
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">Anuluj</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentEditId = null;

        // INICJALIZACJA
        document.addEventListener('DOMContentLoaded', function() {
            makeNotatkiClickable();
        });

        // MODALE
        function openModal() {
            document.getElementById('noteModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('noteModal').style.display = 'none';
            document.getElementById('typ_notatki').value = '';
            document.getElementById('nr_rej_group').classList.add('hidden');
            document.getElementById('pojazd_info').classList.add('hidden');
            document.querySelector('textarea[name="tresc"]').value = '';
        }

        function openEditModal(notatkaId) {
            currentEditId = notatkaId;
            fetch(`/api/notatka/${notatkaId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('edit_tresc').value = data.tresc;
                    document.getElementById('editModal').style.display = 'block';
                })
                .catch(() => alert('B≈ÇƒÖd pobierania notatki'));
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditId = null;
        }

        // TOGGLE TYP NOTATKI
        function toggleNotatkType() {
            const typ = document.getElementById('typ_notatki').value;
            const nrRejGroup = document.getElementById('nr_rej_group');
            const pojazdInfo = document.getElementById('pojazd_info');
            
            if (typ === 'pojazd') {
                nrRejGroup.classList.remove('hidden');
            } else {
                nrRejGroup.classList.add('hidden');
                pojazdInfo.classList.add('hidden');
            }
        }

        // WYSZUKIWANIE
        function filterNotatkiByRej() {
            const filter = document.getElementById('searchRejInput').value.toUpperCase();
            const rows = document.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const nrRej = (row.getAttribute('data-nr-rej') || '').toUpperCase();
                row.style.display = nrRej.includes(filter) ? '' : 'none';
            });
        }

        function clearRejSearch() {
            document.getElementById('searchRejInput').value = '';
            filterNotatkiByRej();
        }

        // KLIKNIƒòCIE W NOTATKƒò POJAZDU
        function makeNotatkiClickable() {
            document.querySelectorAll('.notatka-pojazd').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (e.target.type === 'checkbox') return;
                    const nrRej = this.dataset.nrRej;
                    if (nrRej) window.location.href = `/kosztorysy/${nrRej}`;
                });
            });
        }

        // CHECKBOXY
        function toggleAllCheckboxes() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.note-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
        }

        function getSelectedNotes() {
            const checkboxes = document.querySelectorAll('.note-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // AKCJE GRUPOWE
        function editSelected() {
            const selected = getSelectedNotes();
            if (selected.length === 0) {
                alert('Zaznacz przynajmniej jednƒÖ notatkƒô');
                return;
            }
            if (selected.length > 1) {
                alert('Wybierz tylko jednƒÖ notatkƒô do edycji');
                return;
            }
            
            openEditModal(selected[0]);
        }

        function deleteSelected() {
            const selected = getSelectedNotes();
            if (selected.length === 0) {
                alert('Zaznacz przynajmniej jednƒÖ notatkƒô');
                return;
            }
            
            if (confirm(`Czy na pewno chcesz usunƒÖƒá ${selected.length} notatek?`)) {
                Promise.all(selected.map(id => 
                    fetch(`/notatka/delete/${id}`, { method: 'DELETE' })
                )).then(() => {
                    location.reload();
                }).catch(() => {
                    alert('B≈ÇƒÖd usuwania notatek');
                });
            }
        }

        // POBIERZ INFORMACJE O POJE≈πDZIE
        function pobierzInformacje() {
            const nrRej = document.getElementById('nr_rejestracyjny').value;
            if (!nrRej) {
                alert('Wprowad≈∫ numer rejestracyjny');
                return;
            }

            fetch(`/api/pojazd-info/${nrRej}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    const infoDiv = document.getElementById('pojazd_info');
                    infoDiv.innerHTML = `
                        <h4>üöó ${data.marka} ${data.model} (${data.rok_produkcji})</h4>
                        <p><strong>W≈Ça≈õciciel:</strong> ${data.wlasciciel}</p>
                        <div style="margin: 15px 0;">
                            <strong>üìù Historia notatek:</strong>
                            ${data.notatki && data.notatki.length ? 
                                data.notatki.map(n => `
                                    <div style="background: white; padding: 8px; margin: 3px 0; border-radius: 4px; font-size: 12px;">
                                        <strong>${n.data}:</strong> ${n.tresc}
                                    </div>
                                `).join('') : 
                                '<p>Brak notatek</p>'
                            }
                        </div>
                        <button class="btn-primary" onclick="window.location.href='/kosztorysy/${nrRej}'">
                            üìã Poka≈º kosztorysy w≈Ça≈õciciela
                        </button>
                    `;
                    infoDiv.classList.remove('hidden');
                })
                .catch(() => alert('B≈ÇƒÖd pobierania danych'));
        }

        // EDYCJA NOTATKI
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!currentEditId) return;

            const tresc = document.getElementById('edit_tresc').value;
            
            fetch(`/notatka/edit/${currentEditId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tresc: tresc })
            })
            .then(response => {
                if (response.ok) {
                    closeEditModal();
                    location.reload();
                } else {
                    alert('B≈ÇƒÖd zapisywania zmian');
                }
            })
            .catch(() => alert('B≈ÇƒÖd po≈ÇƒÖczenia'));
        });

        // ZAMYKANIE MODALI PRZEZ KLIKNIƒòCIE T≈ÅA
        window.addEventListener('click', function(event) {
            const modals = ['noteModal', 'editModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>