<!DOCTYPE html>
<html>
<head>
    <title>Notatnik Gƒôbka</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        input, textarea, select { 
            padding: 12px; margin: 5px; border: 1px solid #ddd; 
            border-radius: 6px; font-size: 14px;
        }
        textarea { width: calc(100% - 24px); height: 120px; resize: vertical; box-sizing: border-box; }
        button { 
            padding: 12px 24px; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 14px; transition: all 0.3s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; transform: translateY(-1px); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; transform: translateY(-1px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        
        table { 
            width: 100%; border-collapse: collapse; margin: 20px 0; 
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f9fa; font-weight: 600; }
        .notatka-szybka { background: #fff3cd; }
        .notatka-pojazd { background: #d1ecf1; cursor: pointer; }
        .notatka-pojazd:hover { background: #b8daff; }
        
        /* Modal styles */
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content { 
            background: white; margin: 5% auto; padding: 30px; 
            width: 90%; max-width: 500px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        .close { 
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            cursor: pointer; line-height: 1;
        }
        .close:hover { color: #000; }
        
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-50px);} to {transform: translateY(0);} }
        
        .header { 
            background: white; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .przypomnienia-box {
            background: white; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .przypomnienie-item {
            background: #fff3cd; border-left: 4px solid #ffc107;
            padding: 15px; margin: 10px 0; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .przypomnienie-empty {
            background: #f8f9fa; color: #6c757d; padding: 10px;
            border-radius: 6px; text-align: center; font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Notatnik Warsztatowy</h1>
            <button class="btn-success" onclick="openModal()">+ Dodaj Notatkƒô</button>
        </div>

        <!-- Przypomnienia na dzi≈õ -->
        <div class="przypomnienia-box">
            <h3>üîî Przypomnienia na dzi≈õ</h3>
            <div id="przypomnienia-container">
                <!-- ≈Åadowane dynamicznie -->
            </div>
            <button class="btn-primary" onclick="openReminderModal()">+ Dodaj Przypomnienie</button>
        </div>

        <!-- Modal dodawania notatki -->
        <div id="noteModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h3>Dodaj Notatkƒô</h3>
                <form action="/notatka/add" method="post">
                    <div class="form-group">
                        <select id="typ_notatki" name="typ_notatki" onchange="toggleNotatkType()" required>
                            <option value="">Wybierz typ notatki</option>
                            <option value="szybka">‚ö° Szybka notatka</option>
                            <option value="pojazd">üöô Notatka do pojazdu</option>
                        </select>
                    </div>
                    
                    <div id="nr_rej_group" class="form-group" style="display: none;">
                        <input type="text" id="nr_rejestracyjny" name="nr_rejestracyjny" placeholder="Numer rejestracyjny pojazdu">
                        <button type="button" class="btn-primary" onclick="pobierzInformacje()" style="margin-left: 10px;">üìã Pobierz informacje</button>
                    </div>
                    
                    <div id="pojazd_info" style="display: none; background: #e7f3ff; padding: 15px; margin: 10px 0; border-radius: 6px;">
                        <!-- Informacje o poje≈∫dzie bƒôdƒÖ tutaj -->
                    </div>
                    
                    <div class="form-group">
                        <textarea name="tresc" placeholder="Tre≈õƒá notatki..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn-primary">Zapisz</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Anuluj</button>
                </form>
            </div>
        </div>

        <!-- Modal edycji notatki -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <h3>Edytuj Notatkƒô</h3>
                <form id="editForm">
                    <div class="form-group">
                        <textarea id="edit_tresc" placeholder="Tre≈õƒá notatki..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn-primary">Zapisz zmiany</button>
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">Anuluj</button>
                </form>
            </div>
        </div>

        <!-- Modal przypomnienia -->
        <div id="reminderModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeReminderModal()">&times;</span>
                <h3>Dodaj Przypomnienie</h3>
                <form action="/przypomnienie/add" method="post">
                    <div class="form-group">
                        <select name="notatka_id" id="notatka_select" required>
                            <option value="">Wybierz notatkƒô</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <input type="datetime-local" name="data_przypomnienia" required>
                    </div>
                    
                    <button type="submit" class="btn-primary">Zapisz</button>
                    <button type="button" class="btn-secondary" onclick="closeReminderModal()">Anuluj</button>
                </form>
            </div>
        </div>

        <!-- Wszystkie notatki -->
        <h3>üìù Wszystkie notatki</h3>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Typ</th>
                    <th>W≈Ça≈õciciel</th>
                    <th>Pojazd</th>
                    <th>Tre≈õƒá</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for notatka in notatki %}
                <tr class="notatka-{{ notatka.typ_notatki }}" data-nr-rej="{% if notatka.samochod %}{{ notatka.samochod.nr_rejestracyjny }}{% endif %}">
                    <td>{{ notatka.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>
                        {% if notatka.typ_notatki == 'szybka' %}‚ö° Szybka{% else %}üöô Pojazd{% endif %}
                    </td>
                    <td>
                        {% if notatka.samochod and notatka.samochod.klient %}
                            {{ notatka.samochod.klient.imie }} {{ notatka.samochod.klient.nazwisko }}
                        {% else %}
                            Szybka notatka
                        {% endif %}
                    </td>
                    <td>
                        {% if notatka.samochod %}
                            {{ notatka.samochod.nr_rejestracyjny }}
                            <br><small>{{ notatka.samochod.marka }} {{ notatka.samochod.model }}</small>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ notatka.tresc }}</td>
                    <td>
                        <button class="btn-primary" onclick="editNote('{{ notatka.id }}')">‚úèÔ∏è Edytuj</button>
                        <button class="btn-danger" onclick="deleteNote('{{ notatka.id }}')">üóëÔ∏è Usu≈Ñ</button>
                        
                        <!-- NOWY: Przycisk do kosztorys√≥w -->
                        {% if notatka.samochod %}
                        <button class="btn-success" onclick="openKosztorysy('{{ notatka.samochod.nr_rejestracyjny }}')">
                            üí∞ Kosztorysy
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // ≈Åadowanie przypomnie≈Ñ przy starcie
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Strona za≈Çadowana');
            requestNotificationPermission();
            loadPrzypomnienia();
            startNotificationChecker();
            makeNotatkiClickable();
            
            // Ustaw minimalnƒÖ datƒô na dzi≈õ
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.querySelector('input[type="datetime-local"]').min = now.toISOString().slice(0, 16);
        });

        // NOWA funkcja: Klikalne wiersze notatek pojazdu
        function makeNotatkiClickable() {
            const rows = document.querySelectorAll('.notatka-pojazd');
            rows.forEach(row => {
                row.addEventListener('click', function(e) {
                    // Sprawd≈∫ czy klikniƒôto przycisk
                    if (e.target.tagName === 'BUTTON') return;
                    
                    const nrRej = this.dataset.nrRej;
                    if (nrRej) {
                        window.location.href = `/kosztorysy/${nrRej}`;
                    }
                });
            });
        }

        // Powiadomienia przeglƒÖdarki
        function requestNotificationPermission() {
            console.log('Sprawdzam powiadomienia...');
            if ('Notification' in window) {
                console.log('Obecny status:', Notification.permission);
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        console.log('Pozwolenie:', permission);
                        if (permission === 'granted') {
                            console.log('Powiadomienia w≈ÇƒÖczone');
                            // Test powiadomienia
                            showNotification('Test', 'Powiadomienia dzia≈ÇajƒÖ!');
                        }
                    });
                }
            } else {
                console.log('Powiadomienia nie sƒÖ obs≈Çugiwane');
            }
        }

        function showNotification(title, message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: 'üîî',
                    requireInteraction: true,
                    tag: 'przypomnienie'
                });
            }
        }

        function startNotificationChecker() {
            // Sprawdzaj co 30 sekund
            setInterval(checkActiveReminders, 30000);
            checkActiveReminders(); // Sprawd≈∫ od razu
        }

        function checkActiveReminders() {
            console.log('Sprawdzam aktywne przypomnienia...');
            fetch('/api/przypomnienia-aktywne')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Otrzymane przypomnienia:', data);
                    data.forEach(p => {
                        console.log('Pokazujƒô powiadomienie:', p);
                        showNotification(
                            'üîî Przypomnienie!', 
                            `${p.godzina} - ${p.notatka_tresc}`
                        );
                    });
                })
                .catch(error => {
                    console.error('B≈ÇƒÖd przy sprawdzaniu przypomnie≈Ñ:', error);
                });
        }

        function loadPrzypomnienia() {
            fetch('/api/przypomnienia-dzisiaj')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('przypomnienia-container');
                    if (data.length === 0) {
                        container.innerHTML = '<div class="przypomnienie-empty">‚úÖ Brak przypomnie≈Ñ na dzi≈õ</div>';
                    } else {
                        container.innerHTML = data.map(p => `
                            <div class="przypomnienie-item">
                                <div>
                                    <strong>${p.godzina}</strong> - ${p.notatka_tresc}
                                    ${p.klient ? `<br><small>Klient: ${p.klient}</small>` : ''}
                                </div>
                                <div>
                                    <button class="btn-warning" onclick="markDone(${p.id})">‚úì</button>
                                    <button class="btn-danger" onclick="deleteReminder(${p.id})">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('');
                    }
                });
        }

        function pobierzInformacje() {
            const nrRej = document.getElementById('nr_rejestracyjny').value;
            if (!nrRej) {
                alert('Wprowad≈∫ numer rejestracyjny');
                return;
            }
            
            fetch(`/api/pojazd-info/${nrRej}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    const infoDiv = document.getElementById('pojazd_info');
                    infoDiv.innerHTML = `
                        <h4>üöó ${data.marka} ${data.model} (${data.rok_produkcji})</h4>
                        <p><strong>W≈Ça≈õciciel:</strong> ${data.wlasciciel}</p>
                        
                        <!-- Historia notatek samochodu -->
                        <div style="margin: 15px 0;">
                            <strong>üìù Historia notatek:</strong>
                            ${data.notatki && data.notatki.length ? data.notatki.map(n => `
                                <div style="background: white; padding: 8px; margin: 3px 0; border-radius: 4px; font-size: 12px;">
                                    <strong>${n.data}:</strong> ${n.tresc}
                                </div>
                            `).join('') : '<p>Brak notatek</p>'}
                        </div>
                        
                        <!-- Przycisk do kosztorys√≥w -->
                        <div style="margin: 15px 0;">
                            <button class="btn-primary" onclick="openKosztorysy('${nrRej}')">
                                üìã Poka≈º kosztorysy w≈Ça≈õciciela
                            </button>
                        </div>
                    `;
                    infoDiv.style.display = 'block';
                })
                .catch(error => {
                    console.error('B≈ÇƒÖd:', error);
                    alert('B≈ÇƒÖd pobierania danych');
                });
        }
        
        function openKosztorysy(nrRej) {
            // Otw√≥rz nowƒÖ stronƒô z kosztorysami
            window.location.href = `/kosztorysy/${nrRej}`;
        }

        function openModal() {
            document.getElementById('noteModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('noteModal').style.display = 'none';
            document.getElementById('typ_notatki').value = '';
            document.getElementById('nr_rej_group').style.display = 'none';
            document.getElementById('pojazd_info').style.display = 'none';
        }
        
        function openReminderModal() {
            document.getElementById('reminderModal').style.display = 'block';
            loadNotatki();
        }
        
        function closeReminderModal() {
            document.getElementById('reminderModal').style.display = 'none';
        }
        
        function loadNotatki() {
            fetch('/api/notatki')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('notatka_select');
                    select.innerHTML = '<option value="">Wybierz notatkƒô</option>';
                    data.forEach(notatka => {
                        const option = document.createElement('option');
                        option.value = notatka.id;
                        option.textContent = notatka.tresc;
                        select.appendChild(option);
                    });
                });
        }
        
        function toggleNotatkType() {
            const typ = document.getElementById('typ_notatki').value;
            const nrRej = document.getElementById('nr_rej_group');
            nrRej.style.display = typ === 'pojazd' ? 'block' : 'none';
            document.getElementById('pojazd_info').style.display = 'none';
        }
        
        function deleteNote(id) {
            if(confirm('Czy na pewno chcesz usunƒÖƒá tƒô notatkƒô?')) {
                fetch(`/notatka/delete/${id}`, {method: 'DELETE'})
                .then(() => location.reload());
            }
        }
        
        function editNote(id) {
            // Pobierz dane notatki
            fetch(`/api/notatka/${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('edit_tresc').value = data.tresc;
                    document.getElementById('editModal').style.display = 'block';
                    
                    // Ustaw handler dla formularza
                    document.getElementById('editForm').onsubmit = function(e) {
                        e.preventDefault();
                        saveNoteEdit(id);
                    };
                });
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        function saveNoteEdit(id) {
            const tresc = document.getElementById('edit_tresc').value;
            
            fetch(`/notatka/edit/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({tresc: tresc})
            })
            .then(response => response.json())
            .then(() => {
                closeEditModal();
                location.reload();
            });
        }
        
        function markDone(id) {
            fetch(`/przypomnienie/mark/${id}`, {method: 'POST'})
            .then(() => loadPrzypomnienia());
        }
        
        function deleteReminder(id) {
            if(confirm('UsunƒÖƒá przypomnienie?')) {
                fetch(`/przypomnienie/delete/${id}`, {method: 'DELETE'})
                .then(() => loadPrzypomnienia());
            }
        }
        
        // Zamknij modal po klikniƒôciu poza nim
        window.onclick = function(event) {
            const noteModal = document.getElementById('noteModal');
            const reminderModal = document.getElementById('reminderModal');
            const editModal = document.getElementById('editModal');
            if (event.target == noteModal) closeModal();
            if (event.target == reminderModal) closeReminderModal();
            if (event.target == editModal) closeEditModal();
        }
    </script>
</body>
</html>