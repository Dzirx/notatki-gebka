<!DOCTYPE html>
<html>
<head>
    <title>Notatnik Warsztatowy</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/modules/notatnik/static/css/table.css">
    <link rel="stylesheet" href="/modules/notatnik/static/css/modal.css">
    <link rel="stylesheet" href="/modules/notatnik/static/css/reminders.css">
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üöó Notatnik Warsztatowy</h1>
            <div>
                <button class="btn-success" onclick="openModal()">+ Dodaj Notatkƒô</button>
                <a href="/" class="btn-secondary">‚Üê Dashboard</a>
            </div>
        </div>

        <!-- WYSZUKIWANIE -->
        <div class="search-rej">
            <input type="text" id="searchRejInput" placeholder="Wyszukaj po numerze rejestracyjnym lub tre≈õci notatki..." oninput="filterNotatkiByRej()">
            <button class="btn-secondary" onclick="clearRejSearch()">Wyczy≈õƒá</button>
        </div>

        <!-- AKCJE GRUPOWE -->
        <div class="actions-bar">
            <button class="btn-danger" onclick="deleteSelected()">üóëÔ∏è Usu≈Ñ zaznaczone</button>
            
            <!-- PRZYCISK FILTRA -->
            <button class="btn-info" id="toggleCompletedBtn" onclick="toggleCompletedNotes()">
                ‚úÖ Tylko zako≈Ñczone
            </button>
            
            <!-- PRZYCISK SYNCHRONIZACJI -->
            <button class="btn-warning" onclick="syncTowary()" title="Synchronizuj towary i us≈Çugi z Integry">
                üîÑ Sync Integra
            </button>
        </div>

        <!-- PRZYPOMNIENIA NA DZISIAJ -->
        <div id="todayReminders" class="today-reminders" style="display: none;">
            <h3>‚è∞ Przypomnienia na dzisiaj</h3>
            <div id="todayRemindersList" class="reminder-cards"></div>
        </div>

        <!-- TABELA NOTATEK -->
        <h3>üìù Wszystkie notatki</h3>
        
        <table id="notesTable">
            <thead>
                <tr>
                    <th width="40">
                        <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                    </th>
                    <th width="130">Status</th>
                    <th>Data</th>
                    <th>W≈Ça≈õciciel</th>
                    <th>Pojazd</th>
                    <th>Pracownik</th>
                    <th>Tre≈õƒá</th>
                    <th>Kosztorys</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for notatka in notatki %}
                <tr class="notatka-{{ notatka.typ_notatki }}" data-note-id="{{ notatka.id }}" data-nr-rej="{% if notatka.samochod %}{{ notatka.samochod.nr_rejestracyjny }}{% endif %}" data-status="{{ notatka.status|default('nowa') }}" data-search-content="{% for kosztorys in notatka.kosztorysy %}{% for towar_kosztorys in kosztorys.kosztorysy_towary %}{{ towar_kosztorys.towar.nazwa }} {% endfor %}{% for usluga_kosztorys in kosztorys.kosztorysy_uslug %}{{ usluga_kosztorys.usluga.nazwa }} {% endfor %}{% endfor %}">
                <td>
                        <input type="checkbox" class="note-checkbox" value="{{ notatka.id }}">
                    </td>
                    <td>
                        <div class="status-container">
                            <span class="status-badge status-{{ notatka.status|default('nowa') }}" 
                                  onclick="showStatusMenu({{ notatka.id }}, this)"
                                  title="Kliknij aby zmieniƒá status">
                                {% if notatka.status == 'w_trakcie' %}üü° W trakcie
                                {% elif notatka.status == 'zakonczona' %}üü¢ Zako≈Ñczona
                                {% elif notatka.status == 'klient_poinformowany' %}üî¥ Klient poinformowany
                                {% elif notatka.status == 'dostarczony' %}üü† Dostarczony
                                {% else %}üîµ Nowa{% endif %}
                            </span>
                            <div class="status-menu" id="statusMenu{{ notatka.id }}" style="display: none;">
                                <div class="status-option {% if (notatka.status or 'nowa') == 'nowa' %}current{% endif %}" 
                                     data-status="nowa" data-text="Nowa" onclick="selectStatusFromMenu({{ notatka.id }}, this)">
                                    üîµ Nowa
                                </div>
                                <div class="status-option {% if notatka.status == 'w_trakcie' %}current{% endif %}" 
                                     data-status="w_trakcie" data-text="W trakcie" onclick="selectStatusFromMenu({{ notatka.id }}, this)">
                                    üü° W trakcie
                                </div>
                                <div class="status-option {% if notatka.status == 'zakonczona' %}current{% endif %}" 
                                     data-status="zakonczona" data-text="Zakonczona" onclick="selectStatusFromMenu({{ notatka.id }}, this)">
                                    üü¢ Zako≈Ñczona
                                </div>
                                <div class="status-option {% if notatka.status == 'dostarczony' %}current{% endif %}" 
                                     data-status="dostarczony" data-text="Dostarczony" onclick="selectStatusFromMenu({{ notatka.id }}, this)">
                                    üü† Dostarczony
                                </div>
                                <div class="status-option {% if notatka.status == 'klient_poinformowany' %}current{% endif %}" 
                                     data-status="klient_poinformowany" data-text="Klient poinformowany" onclick="selectStatusFromMenu({{ notatka.id }}, this)">
                                    üî¥ Klient poinformowany
                                </div>
                                <div class="status-option {% if notatka.status == 'niekompletne' %}current{% endif %}" 
                                     data-status="niekompletne" data-text="Niekompletne" onclick="selectStatusFromMenu({{ notatka.id }}, this)">
                                    üü® Niekompletne
                                </div>
                                <div class="status-option {% if notatka.status == 'wprowadzona_do_programu' %}current{% endif %}" 
                                     data-status="wprowadzona_do_programu" data-text="Wprowadzona do programu" onclick="selectStatusFromMenu({{ notatka.id }}, this)">
                                    ‚úÖ Wprowadzona do programu
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <a href="/notatnik/kosztorys/{{ notatka.id }}" style="color: inherit; text-decoration: none;">
                            {{ notatka.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </a>
                    </td>
                    <td>
                        <a href="/notatnik/kosztorys/{{ notatka.id }}" style="color: inherit; text-decoration: none;">
                            {% if notatka.samochod and notatka.samochod.klient %}
                                {{ notatka.samochod.klient.nazwapelna }}
                            {% else %}
                                Szybka notatka
                            {% endif %}
                        </a>
                    </td>
                    <td>
                        <a href="/notatnik/kosztorys/{{ notatka.id }}" style="color: inherit; text-decoration: none;">
                            {% if notatka.samochod %}
                                {{ notatka.samochod.nr_rejestracyjny }}
                                <br><small>{{ notatka.samochod.marka }} {{ notatka.samochod.model }}</small>
                            {% else %}
                                -
                            {% endif %}
                        </a>
                    </td>
                    <td>
                        <a href="/notatnik/kosztorys/{{ notatka.id }}" style="color: inherit; text-decoration: none;">
                            {% if notatka.pracownik %}
                                {{ notatka.pracownik.imie }} {{ notatka.pracownik.nazwisko }}
                            {% else %}
                                <span style="color: #888;">Nie przypisano</span>
                            {% endif %}
                        </a>
                    </td>
                    <td class="note-content">
                        <a href="/notatnik/kosztorys/{{ notatka.id }}" style="color: inherit; text-decoration: none;">
                            {{ notatka.tresc }}
                        </a>
                    </td>
                    <td>
                        {% if notatka.kosztorysy %}
                            {% for kosztorys in notatka.kosztorysy %}
                                <a href="/notatnik/kosztorys-detail/{{ kosztorys.id }}" class="btn-small" style="display: block; margin-bottom: 5px;">
                                    üí∞ {{ kosztorys.numer_kosztorysu or 'KOS' }} - {{ "%.2f"|format(kosztorys.kwota_calkowita) }} z≈Ç
                                </a>
                            {% endfor %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="btn-small btn-warning" onclick="openEditModal({{ notatka.id }})" title="Edytuj notatkƒô">
                                Edytuj
                            </button>
                            <button class="btn-small btn-secondary" onclick="openDetailsModal({{ notatka.id }})" title="Dodatkowe informacje">
                                ‚¨ú
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- PROSTA PAGINACJA -->
        <div class="pagination-wrapper">
            <div class="pagination-controls">
                <label for="itemsPerPage">Poka≈º:</label>
                <select id="itemsPerPage" onchange="changeItemsPerPage()">
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span>na stronƒô </span>
            </div>
            <div class="pagination">
                <button id="prevPage" onclick="goToPreviousPage()" title="Poprzednia strona"> ‚è™</button>
                <div id="pageNumbers"></div>
                <button id="nextPage" onclick="goToNextPage()" title="Nastƒôpna strona">‚è©</button>
            </div>
        </div>

        <!-- MODALE -->
        {% include 'modals/add_note_modal.html' %}
        {% include 'modals/edit_note_modal.html' %}
        {% include 'modals/details_note_modal.html' %}
    </div>

    <script src="/modules/notatnik/static/js/note-core.js"></script>
    <script src="/modules/notatnik/static/js/note-add.js"></script>
    <script src="/modules/notatnik/static/js/towar-search.js"></script>
    <script src="/modules/notatnik/static/js/usluga-search.js"></script>  
    <script src="/modules/notatnik/static/js/note-edit.js"></script>
    <script src="/modules/notatnik/static/js/note-details.js"></script>
    <script src="/modules/notatnik/static/js/pagination.js"></script>
    <script src="/modules/notatnik/static/js/note.js"></script>
</body>
</html>