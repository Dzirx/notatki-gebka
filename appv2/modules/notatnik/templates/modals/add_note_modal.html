<!-- MODAL: DODAJ NOTATKƒò - NOWA WERSJA -->
<link rel="stylesheet" href="/modules/notatnik/static/css/add-modal.css">
<div id="noteModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>üìù Dodaj Notatkƒô</h3>
        
        <form action="/notatnik/add" method="post" id="addNoteForm">
            <!-- KROK 1: WYB√ìR TYPU (zawsze widoczny) -->
            <div class="form-group">
                <label>Wybierz typ notatki:</label>
                <div style="display: flex; gap: 15px; margin: 15px 0;">
                    <button type="button" class="btn btn-secondary note-type-btn" data-type="szybka" onclick="selectNoteType('szybka')">
                        ‚ö° Szybka notatka
                    </button>
                    <button type="button" class="btn btn-secondary note-type-btn" data-type="pojazd" onclick="selectNoteType('pojazd')">
                        üöô Notatka do pojazdu
                    </button>
                </div>
                <input type="hidden" id="typ_notatki" name="typ_notatki" required>
            </div>

            <!-- PRACOWNIK (dla wszystkich typ√≥w notatek) -->
            <div class="form-group">
                <label>Przypisany pracownik (opcjonalnie):</label>
                <select id="pracownik_id" name="pracownik_id">
                    <option value="">-- Wybierz pracownika --</option>
                    <!-- Opcje bƒôdƒÖ za≈Çadowane przez JavaScript -->
                </select>
            </div>

            <!-- PRZYPOMNIENIA (dla wszystkich typ√≥w notatek) -->
            <div class="card" style="margin-bottom: 20px;">
                <h4>‚è∞ Przypomnienia</h4>
                <div class="form-group">
                    <label>Data przypomnienia:</label>
                    <input type="datetime-local" id="data_przypomnienia" name="data_przypomnienia" placeholder="Wybierz datƒô i godzinƒô przypomnienia">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">Opcjonalnie - ustaw kiedy chcesz otrzymaƒá przypomnienie o tej notatce</small>
                </div>
            </div>

            <!-- SEKCJA ZA≈ÅƒÑCZNIK√ìW (ZWINIƒòTA) -->
            <details class="card" style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 6px; padding: 15px;">
                <summary style="cursor: pointer; color: #007bff; font-weight: bold; font-size: 1.1em; margin: -15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    üìé Za≈ÇƒÖczniki (kliknij aby rozwinƒÖƒá)
                </summary>
                <div style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Dodaj pliki (max 10MB ka≈ºdy):</label>
                        <div id="fileUploadZone" class="file-upload-zone">
                            <div class="upload-content">
                                <div class="upload-icon">üìÅ</div>
                                <p>PrzeciƒÖgnij pliki tutaj lub <span class="upload-link">kliknij aby wybraƒá</span></p>
                                <small>Obs≈Çugiwane: PDF, obrazy, dokumenty Word/Excel, pliki tekstowe</small>
                            </div>
                            <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv" style="display: none;">
                        </div>
                        <div id="fileList" class="file-list"></div>
                    </div>
                </div>
            </details>

            <!-- SEKCJA POJAZDU (ukryta domy≈õlnie) -->
            <div id="vehicleSection" class="hidden">
                <div class="card" style="margin-bottom: 20px;">
                    <h4>üöó Dane pojazdu</h4>
                    <!-- WYB√ìR ISTNIEJƒÑCEGO POJAZDU -->
                    <div class="form-group">
                        <label>Wybierz pojazd z bazy:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px; position: relative;">
                                <input type="text" id="searchPojazd" placeholder="Wyszukaj po numerze rejestracyjnym..." 
                                       style="width: 100%;" onkeyup="debounceSearchVehicle()">
                                <div id="vehicleSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                                <input type="hidden" id="selectedVehicleId" value="">
                                <input type="hidden" id="nr_rejestracyjny" name="nr_rejestracyjny" value="">
                            </div>
                            <button type="button" class="btn btn-info" onclick="pobierzKosztorysyZIntegra()">
                                üìã Pobierz kosztorysy z integra
                            </button>
                        </div>
                        <div id="selectedVehicleInfo" style="margin-top: 10px; display: none;">
                            <!-- Tu bƒôdƒÖ wy≈õwietlane dane wybranego pojazdu -->
                        </div>
                    </div>
                    
                    <!-- STATUS SPRAWDZANIA W INTEGRZE -->
                    <div id="vehicleCheckStatus" style="margin-top: 10px; display: none;"></div>
                    
                    <!-- WYSZUKIWANIE Z W≈ÅASNEJ BAZY (ZWINIƒòTE) -->
                    <details style="margin-top: 15px; border: 1px solid #ddd; border-radius: 6px; padding: 15px; background: #f8f9fa;">
                        <summary style="cursor: pointer; color: #007bff; font-weight: bold; font-size: 1.0em; margin: -15px; padding: 15px; background: #e9f4ff; border-radius: 6px;">
                            üîç Wyszukaj w lokalnej bazie danych (kliknij aby rozwinƒÖƒá)
                        </summary>
                        <div style="margin-top: 15px;">
                            <label>Wyszukaj pojazd tylko w lokalnej bazie:</label>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px; position: relative;">
                                    <input type="text" id="searchPojazdLocal" placeholder="Wyszukaj w lokalnej bazie..." 
                                           style="width: 100%; background: #fff3cd; border: 1px solid #ffeaa7;" onkeyup="debounceSearchVehicleLocal()">
                                    <div id="vehicleSearchResultsLocal" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                                </div>
                                <small style="color: #856404; width: 100%; margin-top: 5px;">
                                    ‚ö†Ô∏è Wyszukuje tylko pojazdy zapisane w lokalnej bazie (bez sprawdzania w systemie Integra)
                                </small>
                            </div>
                            <div id="selectedVehicleInfoLocal" style="margin-top: 10px; display: none; background: #d1ecf1; padding: 10px; border-radius: 4px; border: 1px solid #bee5eb;">
                                <!-- Tu bƒôdƒÖ wy≈õwietlane dane wybranego pojazdu z lokalnej bazy -->
                            </div>
                        </div>
                    </details>
                </div>

                <!-- SEKCJA DODANIA SAMOCHODU (ZWINIƒòTA) -->
                <details class="card" style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 6px; padding: 15px;">
                    <summary style="cursor: pointer; color: #007bff; font-weight: bold; font-size: 1.1em; margin: -15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        üöó Dodaj samoch√≥d do bazy (kliknij aby rozwinƒÖƒá)
                    </summary>
                    <div style="margin-top: 15px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <div style="flex: 1; min-width: 200px;">
                                <label>Numer rejestracyjny: <span style="color: red;">*</span></label>
                                <input type="text" id="carNrRej" placeholder="np. GDA55555" style="text-transform: uppercase;">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label>Marka: <span style="color: red;">*</span></label>
                                <input type="text" id="carMarka" placeholder="np. Toyota">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label>Model: <span style="color: red;">*</span></label>
                                <input type="text" id="carModel" placeholder="np. Corolla">
                            </div>
                            <div style="flex: 1; min-width: 120px;">
                                <label>Rok produkcji:</label>
                                <input type="number" id="carRok" placeholder="2020" min="1950" max="2030">
                            </div>
                        </div>
                        
                        <h5 style="margin: 15px 0 10px 0;">üë§ Przypisz do klienta</h5>
                        <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                            <div style="flex: 2; min-width: 250px;">
                                <label>Wybierz istniejƒÖcego klienta:</label>
                                <div style="position: relative;">
                                    <input type="text" id="searchKlient" placeholder="Wyszukaj klienta (nazwa, telefon, NIP)..." style="width: 100%;">
                                    <div id="klientSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                                    <input type="hidden" id="selectedKlientId" value="">
                                </div>
                            </div>
                            <div>
                                <button type="button" class="btn btn-success" onclick="addCarToDatabase()" style="white-space: nowrap;">üöó Dodaj samoch√≥d</button>
                            </div>
                        </div>
                        
                        <!-- Nowy klient -->
                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; color: #007bff; font-weight: bold;">‚ûï Lub dodaj nowego klienta</summary>
                            <div style="margin-top: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <label>Imiƒô i nazwisko:</label>
                                        <input type="text" id="newKlientNazwa" placeholder="Jan Kowalski">
                                    </div>
                                    <div style="flex: 1; min-width: 150px;">
                                        <label>Telefon:</label>
                                        <input type="text" id="newKlientTelefon" placeholder="123-456-789">
                                    </div>
                                    <div style="flex: 1; min-width: 200px;">
                                        <label>Email (opcjonalnie):</label>
                                        <input type="email" id="newKlientEmail" placeholder="jan@example.com">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                                    <div style="flex: 1; min-width: 150px;">
                                        <label>NIP (opcjonalnie):</label>
                                        <input type="text" id="newKlientNip" placeholder="1234567890">
                                    </div>
                                    <div style="flex: 2; min-width: 200px;">
                                        <label>Nazwa firmy (opcjonalnie):</label>
                                        <input type="text" id="newKlientFirma" placeholder="Nazwa firmy">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addCarWithNewClient()">üë§ Dodaj klienta i samoch√≥d</button>
                            </div>
                        </details>
                    </div>
                </details>

                <!-- SEKCJA KOSZTORYS√ìW Z INTEGRA -->
                <div id="integraSection" class="card hidden" style="margin-bottom: 20px;">
                    <h4>üì• Kosztorysy z systemu integra</h4>
                    <div id="integraResults">
                        <!-- Tutaj bƒôdƒÖ wyniki z integra -->
                    </div>
                </div>

                <!-- SEKCJA W≈ÅASNEGO KOSZTORYSU -->
                <div id="customCostSection" class="card" style="margin-bottom: 20px;">
                    <h4>‚ûï Dodaj w≈Çasny kosztorys</h4>
                    
                    <div class="form-group">
                        <label>Numer kosztorysu:</label>
                        <input type="text" id="customCostNumber" placeholder="np. KOS-2024-001">
                    </div>
                    
                    <div class="form-group">
                        <label>Opis kosztorysu:</label>
                        <textarea id="customCostDescription" placeholder="Opis prac..." style="min-height: 60px;"></textarea>
                    </div>

                    <!-- TOWARY -->
                    <div style="margin: 20px 0;">
                        <h5>üì¶ Towary</h5>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px; position: relative;">
                                <input type="text" id="searchTowar" placeholder="Wyszukaj towar (nazwa lub nr katalogowy)..." style="width: 100%;">
                                <div id="towarSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                                <input type="hidden" id="selectedTowarId" value="">
                                <input type="hidden" id="selectedTowarData" value="">
                            </div>
                            <input type="number" id="towarIlosc" placeholder="Ilo≈õƒá" step="1" min="1" style="width: 100px;">
                            <input type="number" id="towarCena" placeholder="Cena" step="0.01" style="width: 120px;">
                            <button type="button" class="btn btn-success" onclick="addTowarToCost()">+ Dodaj</button>
                        </div>
                        
                        <!-- W≈ÅASNY TOWAR -->
                        <details style="margin-bottom: 15px;">
                            <summary style="cursor: pointer; color: #007bff;">‚ûï Dodaj w≈Çasny towar</summary>
                            <div style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                                    <input type="text" id="customTowarNazwa" placeholder="Nazwa towaru" style="flex: 2; min-width: 150px;">
                                    <input type="text" id="customTowarNumer" placeholder="Nr katalogowy" style="flex: 1; min-width: 100px;">
                                    <input type="text" id="customTowarProducent" placeholder="Producent (opcjonalnie)" style="flex: 1; min-width: 120px;">
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                                    <select id="customTowarRodzaj" style="flex: 1; min-width: 120px;">
                                        <option value="">-- Rodzaj opony (opcjonalnie) --</option>
                                        <option value="letnia">Letnia</option>
                                        <option value="zimowa">Zimowa</option>
                                        <option value="ca≈Çoroczna">Ca≈Çoroczna</option>
                                    </select>
                                    <select id="customTowarTyp" style="flex: 1; min-width: 120px;">
                                        <option value="">-- Typ opony (opcjonalnie) --</option>
                                        <option value="osobowa">Osobowa</option>
                                        <option value="dostawcza">Dostawcza</option>
                                        <option value="ciƒô≈ºarowa">Ciƒô≈ºarowa</option>
                                    </select>
                                    <input type="text" id="customTowarIndeks" placeholder="Indeks no≈õno≈õci (opcjonalnie)" style="flex: 1; min-width: 120px;">
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <input type="number" id="customTowarIlosc" placeholder="Ilo≈õƒá" step="1" min="1" style="width: 100px;">
                                    <input type="number" id="customTowarCena" placeholder="Cena" step="0.01" style="width: 120px;">
                                    <button type="button" class="btn btn-primary" onclick="addCustomTowarToCost()">+ Dodaj w≈Çasny</button>
                                </div>
                            </div>
                        </details>
                        
                        <div id="selectedTowary"></div>
                    </div>

                    <!-- US≈ÅUGI -->
                    <div style="margin: 20px 0;">
                        <h5>üîß Us≈Çugi</h5>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px; position: relative;">
                                <input type="text" id="searchUsluga" placeholder="Wyszukaj us≈Çugƒô..." style="width: 100%;">
                                <div id="uslugaSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                                <input type="hidden" id="selectedUslugaId" value="">
                                <input type="hidden" id="selectedUslugaData" value="">
                            </div>
                            <input type="number" id="uslugaIlosc" placeholder="Ilo≈õƒá" step="1" min="1" style="width: 100px;">
                            <input type="number" id="uslugaCena" placeholder="Cena" step="0.01" style="width: 120px;">
                            <button type="button" class="btn btn-success" onclick="addUslugaToCost()">+ Dodaj</button>
                        </div>
                        
                        <!-- W≈ÅASNA US≈ÅUGA -->
                        <details style="margin-bottom: 15px;">
                            <summary style="cursor: pointer; color: #007bff;">‚ûï Dodaj w≈ÇasnƒÖ us≈Çugƒô</summary>
                            <div style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <input type="text" id="customUslugaNazwa" placeholder="Nazwa us≈Çugi" style="flex: 1; min-width: 150px;">
                                <input type="number" id="customUslugaIlosc" placeholder="Ilo≈õƒá" step="1" min="1" style="width: 100px;">
                                <input type="number" id="customUslugaCena" placeholder="Cena" step="0.01" style="width: 120px;">
                                <button type="button" class="btn btn-primary" onclick="addCustomUslugaToCost()">+ Dodaj w≈ÇasnƒÖ</button>
                            </div>
                        </details>
                        
                        <div id="selectedUslugi"></div>
                    </div>

                    <!-- PODSUMOWANIE KOSZTORYSU -->
                    <div id="costSummary" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 20px; display: none;">
                        <h5>üíµ Podsumowanie kosztorysu</h5>
                        <div id="costTotal" style="font-size: 1.2em; font-weight: bold; color: #28a745;"></div>
                    </div>
                </div>
            </div>

            <!-- TRE≈öƒÜ NOTATKI (zawsze na ko≈Ñcu) -->
            <div id="noteContentSection" class="hidden">
                <div class="form-group">
                    <label>Tre≈õƒá notatki:</label>
                    <textarea name="tresc" id="noteTresc" placeholder="Opisz wykonane prace, ustalone ustalenia lub uwagi..." style="min-height: 100px;"></textarea>
                </div>
            </div>

            <!-- UKRYTE POLA -->
            <input type="hidden" id="importowane_kosztorysy" name="importowane_kosztorysy" value="">
            <input type="hidden" id="towary_json" name="towary_json" value="[]">
            <input type="hidden" id="uslugi_json" name="uslugi_json" value="[]">
            <input type="hidden" id="numer_kosztorysu" name="numer_kosztorysu" value="">
            <input type="hidden" id="opis_kosztorysu" name="opis_kosztorysu" value="">

            <!-- PRZYCISKI AKCJI -->
            <div id="actionButtons" class="hidden" style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                <button type="submit" class="btn btn-success">üíæ Zapisz notatkƒô</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå Anuluj</button>
            </div>
        </form>
    </div>
</div>
